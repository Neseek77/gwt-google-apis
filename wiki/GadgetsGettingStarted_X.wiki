#summary How to write and debug a Gadget using GWT

= Getting Started with Gadgets and GWT =

The gadgets library for GWT simplifies gadget development by automatically generating a [http://code.google.com/apis/gadgets/docs/legacy/reference.html#XML_Ref Gadget Specification] from Java source, inserting a selection script in the specification much like a regular GWT project.  After compiling your gadget with GWT, all files are in place to [http://code.google.com/apis/gadgets/docs/legacy/publish.html publish] your gadget.

Please note that the gadget library currently only supports the legacy gadgets API based on the _IG_... namespace.

This guide will get you started writing your first gadget.  Before you start, make sure you are familiar with [http://www.google.com/ig iGoogle] and the [http://code.google.com/apis/gadgets/docs/legacy/dev_guide.html gadgets developer site].


== Assumptions ==
 
  * You are already familiar with [http://code.google.com/webtoolkit/overview.html Google Web Toolkit]
  * You know how to [http://code.google.com/eclipse/docs/creating_new_webapp.html create a new GWT project.]
  * You are using GWT 2.0 or later.

== Downloading the gadget library for GWT ==

You can download the latest release of the library from the [http://code.google.com/p/gwt-google-apis/downloads/ project download page]. After you download the distribution, uncompress it.  Inside the folder you will find a .jar file named `gwt-gadgets.jar`. 

You can either reference the `.jar` file from the folder that you uncompressed the project in, or copy it to another location, such as the location of your GWT distribution (containing `gwt-dev.jar` and `gwt-user.jar` files).  In this example, we've chosen to copy the file to the path `/usr/local/gadgets`.

== Differences between a standard GWT project and a GWT gadget project==

Look at the sample program _Hello Gadgets_ that ships with the `gwt-gadgets` distribution

   [http://code.google.com/p/gwt-google-apis/source/browse/trunk/gadgets/samples/hellogadgets/src/com/google/gwt/gadgets/sample/hellogadgets/client/HelloGadgets.java HelloGadgets.java]

There are some differences you will notice from a standard GWT project.

  # There is no class that implements the [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/core/client/EntryPoint.html EntryPoint] interface.
  # The entry point class is a subclass of [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/Gadget.html Gadget].
  # There is an `@ModulePrefs` annotation on the class
  # There is a relationship between the [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/Gadget.html Gadget] subclass and the [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/UserPreferences.html UserPreferences] subclass named `HelloPreferences`.


These differences derive from the fact that a gadget must adhere to a specific framework as described in the [http://code.google.com/apis/gadgets/docs/legacy/dev_guide.html gadget developer's documentation].  To meet this requirement, gadget support is implemented using a custom [http://google-web-toolkit.googlecode.com/svn/javadoc/2.0/com/google/gwt/core/ext/Linker.html GWT Linker]. 

== Creating a new GWT Project ==

Start by creating a new GWT project called !SimpleGadget as described in the [http://code.google.com/eclipse/docs/creating_new_webapp.html Google Plugin for Eclipse user's guide.]

Since we are working with an additional library, add `gwt-gadgets.jar` to the Java classpath.  Then, add the inherits line for `com.google.gwt.gadgets.Gadgets` to your module.

{{{
    <inherits name='com.google.gwt.gadgets.Gadgets' />
}}}

=== Modify the Project ===

Start by opening up `SimpleGadget.java` and changing the class declaration to read:

{{{
import com.google.gwt.gadgets.client.Gadget;
import com.google.gwt.gadgets.client.UserPreferences;

   public class SimpleGadget extends Gadget<UserPreferences> 
}}}

Remove the `onModuleLoad()` method.  No constructor is necessary.

Next, you need to implement the `init(UserPreferences)` method from the `Gadget` class.  This sample implements a very simple body for the Gadget.

{{{
  @Override
  protected void init(UserPreferences preferences) {
    Button simpleButton = new Button("SimpleGadget");
    simpleButton.addClickHandler(new ClickHandler() {
      public void onClick(ClickEvent event) {
        Window.alert("Hello World!");
      }
    });
    RootPanel.get().add(simpleButton);
  }
}}}


Finally, above the class statement, add an annotation to set the gadget title, author and email:

{{{
@ModulePrefs(title = "SimpleGadget", author = "yournamehere", author_email = "yournamehere@gmail.com")
}}}

[http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/Gadget.ModulePrefs.html @ModulePrefs] provides attributes to the [http://code.google.com/apis/gadgets/docs/legacy/reference.html#Moduleprefs_Ref  `<ModulePrefs>`] tag in the Gadget Specification.

== Compiling your Gadget ==

You now have the basics of a Gadget in place, but there are a few more steps required to run the Gadget, so let's compile and deploy what we have to a Gadget container like iGoogle.

Use the Google Plugin for Eclipse to build your project in Web mode. The output of the compiler will have:
   * Several `.cache.js` files, one per compiler permutation.  These contain the application logic for your gadget compiled for each browser/locale combination.
   * A `SampleGadgets.html` file.  This is just a holdover from a regular GWT module and is not used in publishing a gadget.  
   * Other resources such as image files.
   * A `*.xml` file.  This is the gadget specification file that you will need in order to [http://code.google.com/apis/gadgets/docs/legacy/publish.html publish your gadget]. It contains:
       * Information about your gadget specified in `@ModulePrefs` 
       * Which features your gadget needs
       * A user preference value specification 
       * !JavaScript code for initializing the Gadget API and loading one of the GWT compiler permutations.

== Uploading your Gadget to iGoogle ==

To test our your newly compiled code, take the output files above (located in the `SimpleGadget/war` directory unless you changed GWT's output location) and upload them all to the same directory on a public web server. 

Next, go to [http://www.google.com/ig iGoogle] and click the "Add Stuff" link in the upper right corner. Click "Add Feed or Gadget" and specify the full URL to the gadget spec file (`com.example.simplegadget.client.SimpleGadget.gadget.xml`) that you uploaded to your server in the previous step. Click "Add" and go back to your iGoogle page. 

Congratulations. Your new (if slightly boring) Gadget should  appear on the page.

=== Caching effects from the Gadget container ===

One important aspect of the Gadget infrastructure you must be aware of is that Gadget containers, such as iGoogle, are free to cache the Gadget specifications.  In the case of iGoogle, the default caching is one hour.  See FAQ item [http://code.google.com/apis/gadgets/faq.html#CantSeeChanges I updated my gadget, but I can't see my changes. What's going on?]  

As a developer, you can use the [http://code.google.com/apis/gadgets/docs/legacy/tools.html#Dev_Gadget Developer Gadget] on iGoogle to turn off caching for your view of the gadget by un-checking the `Cached` checkbox beside the URL of your Gadget Spec.

For deploying a gadget developed with GWT, the caching by Gadget Containers is a significant issue. If you deploy your GWT application and remove old versions of the compiled program, the cached version of the Gadget spec will still refer to the old (and now deleted) files and end users will experience an outage until the cache is refreshed.  

== Adding container features ==

If the Gadget requires access to features of the container, it should implement the appropriate _!NeedsFoo_ interfaces, which currently include:
 
  * [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/NeedsAnalytics.html NeedsAnalytics]
  * [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/NeedsDynamicHeight.html NeedsDynamicHeight]
  * [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/NeedsIntrinsics.html NeedsIntrinsics]
  * [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/NeedsSetPrefs.html NeedsSetPrefs]
  * [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/NeedsSetTitle.html NeedsSetTitle]


At runtime, all feature setters will be called strictly before [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/Gadget.html#init(T) init(UserPreferences)]. The order in which the setters are called is undefined.


For example, if you wanted to use the optional feature to set the title dynamically, you would need to inherit the `NeedsSetTitle` interface. The following code sets the title of the gadget dynamically. 

{{{
/**
 * Entry point classes define <code>onModuleLoad()</code>.
 */
@ModulePrefs(title="Original Title", author = "yournamehere", author_email = "yournamehere@gmail.com")
public class NeedsSetTitleGadget extends Gadget<UserPreferences> implements
    NeedsSetTitle {
  int titleIndex = 0;
  String[] titles = { "NeedsTitle Example", "Hello World!","Goodbye World!"};
  SetTitleFeature titleFeature;

  @Override
  protected void init(UserPreferences preferences) {
    Button changeTitleButton = new Button("Change Title");
    changeTitleButton.addClickHandler(new ClickHandler() {

      public void onClick(ClickEvent event) {
        titleFeature.setTitle(titles[titleIndex++ % titles.length]);
      }
      
    });
   RootPanel.get().add(changeTitleButton);
  }

  public void initializeFeature(SetTitleFeature feature) {
    this.titleFeature = feature;
  }
}
}}}

Here's the resulting Gadget:

   [http://gwt-google-apis.googlecode.com/svn/wiki/GettingStartedGadgets-ChangeTitle.png]


== Specifying Preferences ==

The gadget spec allows you to specify user preferences for your gadget.  User preferences allow the gadget container to provide a user interface and storage for parameters used to customize the gadget. 

In GWT, access to user preferences is provided through a user-defined subtype of the [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/UserPreferences.html UserPreferences] interface. Each preference should be defined as a zero-argument method, returning the desired type of [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/UserPreferences.Preference.html UserPreferences.Preference Preference]. The Gadget type should be parameterized with the specific [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/UserPreferences.html UserPreferences] subtype, which will be provided to the [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/com/google/gwt/gadgets/client/Gadget.html#init(T) init(UserPreferences)] method. 


The following sample code shows how to implement a simple checkbox type of preference.  In this sample, the gadget displays a different menu depending on whether the user checks the _Vegetarian_ checkbox.  First, the custom `UserPreference` subclass:

{{{
import com.google.gwt.gadgets.client.BooleanPreference;
import com.google.gwt.gadgets.client.UserPreferences;

public interface MealPreferences extends UserPreferences {

  @PreferenceAttributes(display_name = "Vegetarian", default_value = "false")
  BooleanPreference noMeat();

}
}}}

Next, a `Gadget` class that uses the `MealPreferences` class.  The meal choices are displayed in a table - when the user selects a dish, an alert window is opened.

{{{
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.gadgets.client.Gadget;
import com.google.gwt.gadgets.client.Gadget.ModulePrefs;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.CheckBox;
import com.google.gwt.user.client.ui.FlexTable;
import com.google.gwt.user.client.ui.Panel;
import com.google.gwt.user.client.ui.RootPanel;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.Widget;

/**
 * Entry point classes define <code>onModuleLoad()</code>.
 */
@ModulePrefs(title = "MealPreferences Gadget", author = "yournamehere", author_email = "yournamehere@gmail.com")
public class MealPreferencesGadget extends Gadget<MealPreferences> {

  private String[] meatEntrees = {
      "steak kabobs", "lamb fricassee", "chicken kiev"};
  private String[] vegEntrees = {"saag paneer", "baba ganoush", "boca burger"};
  private String[] dishes;

  @Override
  protected void init(MealPreferences preferences) {
    initDishes(preferences);

    // Create a table with a checklist of all available dishes based on the
    // user's dietary preferences.
    Panel p = new VerticalPanel();
    p.setWidth("100%");

    FlexTable ft = new FlexTable();

    int index = 0;
    for (String dish : dishes) {
      CheckBox cb = new CheckBox();
      final String dishCopy = dish;
      cb.addClickHandler(new ClickHandler() {
        public void onClick(ClickEvent event) {
          Window.alert("Your order of " + dishCopy + " will be right up.");
        }
      });
      ft.setWidget(index, 0, cb);
      ft.setHTML(index, 1, dish);
      index++;
    }
    p.add(ft);
    RootPanel.get().add(p);
  }

  private void initDishes(MealPreferences preferences) {
    // Customize the list of dishes to the dining preferences of the user.
    if (preferences.noMeat().getValue().booleanValue()) {
      dishes = vegEntrees;
    } else {
      dishes = meatEntrees;
    }
  }
}
}}}


Here is a screen shot of the resulting gadget's preferences menu in iGoogle:

   [http://gwt-google-apis.googlecode.com/svn/wiki/GettingStartedGadgets-MealPreferences.png]


== Syndicating your Gadget ==


Once your testing is complete, you can list your gadget in the [http://code.google.com/apis/gadgets/docs/legacy/publish.html#Syndication content directory] and syndicate it to any webpage, not just a Gadget container. For more information, see the [http://code.google.com/apis/gadgets/docs/legacy/publish.html#Syndication Publishing Using Syndication] guidelines and documentation. Be sure to note the restrictions on syndicated gadgets, such as the storage of preferences. 
 

==Next steps==

For more information what you can do with Gadgets, read the [http://code.google.com/apis/gadgets/docs/legacy/dev_guide.html Gadget documentation] and the [http://gwt-google-apis.googlecode.com/svn/javadoc/gadgets/1.1/index.html Gadget Library for GWT class reference].
