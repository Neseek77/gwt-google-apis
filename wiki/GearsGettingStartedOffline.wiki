#summary Using the Gears Offline Module in a GWT project

=Using the Gears Offline Module in a GWT project=

==Creating a new GWT project==

Start by creating a new GWT project called !GearsOfflineTutorial as described in the [http://code.google.com/docreader/#p(google-web-toolkit-doc-1-5)s(google-web-toolkit-doc-1-5)t(GettingStarted) GWT Tutorial]. 

Since we are working with an additional library, we use the command line argument `-addToClassPath` which adds the library `/usr/local/gwt-gears/gwt-gears.jar` to the Java classpath for the launch, compile and .and eclipse definitions. Note that for the purposes of this example we assume `gwt-gears.jar` has been unpacked in `/usr/local/gwt-gears` and that you are using the Eclipse IDE.

{{{
$PP_OFF
$ projectCreator -eclipse GearsOfflineTutorial -out GearsOfflineTutorial \
     -addToClassPath /usr/local/gwt-gears/gwt-gears.jar
}}}

{{{
$PP_OFF
$ applicationCreator -eclipse GearsOfflineTutorial \
     -out GearsOfflineTutorial \
     -addToClassPath /usr/local/gwt-gears/gwt-gears.jar \
     -addModule com.google.gwt.gears.Offline \
     com.example.google.gwt.gearsofflinetutorial.client.GearsOfflineTutorial
}}}


You should now have a standard project set up. Before continuing, make sure you can launch the skeleton project in hosted mode by either running _!GearsOfflineTutorial-shell_ from the command line or using the _Run_ configuration from Eclipse. 

You should see the skeleton project come up:

  http://gwt-google-apis.googlecode.com/svn/wiki/GettingStartedBasic1.png

Also test out compilation with the `GearsOfflineTutorial-compile` script or the _Compile/Browse_ button in hosted mode

{{{
$PP_OFF
$ ./GearsOfflineTutorial-compile
Compiling into ./www/com.example.google.gwt.gearsstutorial.GearsOfflineTutorial
Copying all files found on public path
Compilation succeeded
}}}

== Update the HTML host file ==

Replace the body of the HTML host file `com/example/google/gwt/gearsofflinetutorial/public/GearsOfflineTutorial.html` with a `<div>` tag that we can use for the GWT application.

{{{
<body>

    <h1>Gears Offline Tutorial</h1>

    <div id="gearsTutorial">

</body>
}}}

== Use a Offline object in the  .java source ==

The [http://gwt-google-apis.googlecode.com/svn/javadoc/gears/1.1/com/google/gwt/gears/offline/client/Offline.html Offline] class provides a convenient way to generate a Gears manifest file.  It works by using a custom GWT linker to track all the generated !JavaScript files as well as resources on the public path.

To complete the `GearsOfflineTutorial.java`, you can replace the `onModuleLoad()` with the following methods that create a [http://gwt-google-apis.googlecode.com/svn/javadoc/gears/1.1/com/google/gwt/gears/client/localserver/ManagedResourceStore.html ManagedResourceStore] using the Offline object.

{{{
package com.example.google.gwt.gearsdatabasetutorial.client;

import com.google.gwt.core.client.EntryPoint;
import com.google.gwt.gears.client.Factory;
import com.google.gwt.gears.client.GearsException;
import com.google.gwt.gears.client.localserver.LocalServer;
import com.google.gwt.gears.client.localserver.ManagedResourceStore;
import com.google.gwt.gears.offline.client.Offline;
import com.google.gwt.user.client.Timer;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.ClickListener;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.HorizontalPanel;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.RootPanel;
import com.google.gwt.user.client.ui.VerticalPanel;
import com.google.gwt.user.client.ui.Widget;

/**
 * Tutorial for using Google Gears Offline support
 */
public class GearsOfflineTutorial implements EntryPoint {

  private final Button createManagedResourceStoreButton = new Button(
      "Go Offline");

  private final Button removeManagedResourceStoreButton = new Button(
      "Remove Offline Store");

  private final Label statusLabel = new Label();

  public void onModuleLoad() {
    
    VerticalPanel vpanel = new VerticalPanel();
    vpanel.setSpacing(5);
    vpanel.getElement().getStyle().setPropertyPx("margin", 10);
    RootPanel.get().add(vpanel);
    HorizontalPanel hpanel = new HorizontalPanel();
    vpanel.add(hpanel);
    vpanel.add(statusLabel);

    // Draw a different interface if the application can be served offline.
    try {
      LocalServer server = Factory.getInstance().createLocalServer();
      hpanel.add(createManagedResourceStoreButton);
      // This check to see if the host page can be served locally
      if (server.canServeLocally(Window.Location.getPath())) {
        createManagedResourceStoreButton.setText("Refresh Manifest");
        // Include a resource the needs to be added to the manifest
        HTML iframe = new HTML("<iframe src=\"iframe.html\"></iframe>");
        vpanel.add(iframe);
        // Give the user an opportunity to delete the managed resource store
        hpanel.add(removeManagedResourceStoreButton);
      }
    } catch (GearsException ex) {
      Window.alert("Exception: " + ex);
      return;
    }

    createManagedResourceStoreButton.addClickListener(new ClickListener() {
      public void onClick(Widget sender) {
        statusLabel.setText("Starting update");
        createManagedResourceStore();
      }
    });

    removeManagedResourceStoreButton.addClickListener(new ClickListener() {
      public void onClick(Widget sender) {
        try {
          LocalServer server = Factory.getInstance().createLocalServer();
          ManagedResourceStore store = Offline.getManagedResourceStore();
          server.removeManagedStore(store.getName());
          statusLabel.setText("Removed ManagedResourceStore. Please refresh the page to see the changes.");
        } catch (GearsException e) {
          statusLabel.setText(e.getMessage());
        }
      }
    });
  }

  private void createManagedResourceStore() {
    try {
      final ManagedResourceStore managedResourceStore = Offline.getManagedResourceStore();

      new Timer() {
        final String oldVersion = managedResourceStore.getCurrentVersion();
        String transferringData = "Transferring data";

        @Override
        public void run() {
          switch (managedResourceStore.getUpdateStatus()) {
            case ManagedResourceStore.UPDATE_OK:
              if (managedResourceStore.getCurrentVersion().equals(oldVersion)) {
                statusLabel.setText("No update was available.");
              } else {
                statusLabel.setText("Update to "
                    + managedResourceStore.getCurrentVersion()
                    + " was completed.  Please refresh the page to see the changes.");
              }
              break;
            case ManagedResourceStore.UPDATE_CHECKING:
            case ManagedResourceStore.UPDATE_DOWNLOADING:
              transferringData += ".";
              statusLabel.setText(transferringData);
              schedule(500);
              break;
            case ManagedResourceStore.UPDATE_FAILED:
              statusLabel.setText(managedResourceStore.getLastErrorMessage());
              break;
          }
        }
      }.schedule(500);

    } catch (GearsException e) {
      statusLabel.setText("");
      Window.alert(e.getMessage());
    }
  }
}
}}}

This demo first displays a button to create a ManagedResourceStore using the Offline class.  Once the button is presses, the update process begins.  When all files are downloaded and available in offline mode, you'll be prompted to refresh the application (using the browser's refresh button.)  You can also disconnect the network to show that the operations are occurring locally.

  http://gwt-google-apis.googlecode.com/svn/wiki/GearsOfflineGettingStarted1.png

After the resources are loaded into the ManagedResourceStore, an HTML iframe is loaded from the public path and added to the page.   Also, the buttons change to allow you to attempt to update or to remove the store.  

  http://gwt-google-apis.googlecode.com/svn/wiki/GearsOfflineGettingStarted2.png

== How to deal with browsers that do not support Gears ==

The Gears plugin is a component that must be installed by users and is not supported on all browser configurations.  Thus, you will want to let users know when your application detects that the Gears plugin is not installed or not supported.  You can create a rebind rule in your GWT module that will invoke a different !EntryPoint in this instance.

=== Add a new !EntryPoint class ===

The following is an example of an alternative !EntryPoint class is used when the Gears plugin is not detected in the browser.  Save this class as `NoGears.java` in the same package with the `GearsOfflineTutorial` class.

{{{
package com.example.google.gwt.gearsdatabasetutorial.client;

import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.RootPanel;

/**
 * This entry point will be used when no Gears plugin is detected
 */
public class NoGears {
  public void onModuleLoad() {
    RootPanel rootPanel = RootPanel.get();
    rootPanel.add(new HTML(
        "<font color=\"red\">ERROR: This browser does not support Gears. "
        + " Please <a href=\"http://gears.google.com/\">install Gears</a> " 
        + "and reload the application.  Note that GWT Gears applications can "
        + "only be debugged in hosted mode on Windows.</font>"));
  }
}
}}}

=== Modify !GearsOfflineTutorial.gwt.xml ===

In order to tell the compiler to add logic to the selection script to pull up your rebound entry point, you need to create a [http://code.google.com/docreader/#p(google-web-toolkit-doc-1-5)s(google-web-toolkit-doc-1-5)t(DevGuideDeferredBindingReplacement) replace-class-with] rule in your `gwt.xml` module file.  

{{{
  <!-- Rebind the entry point if Gears is not installed -->
  <replace-with class="com.example.google.gwt.gearsdatabasetutorial.client.NoGears">
    <when-type-is class="com.example.google.gwt.gearsdatabasetutorial.client.GearsOfflineTutorial"/>
    <when-property-is name="gears.installed" value="false"/>
  </replace-with>
}}}

== Run the !GearsOfflineTutorial sample project ==

Now, you should be able to execute your sample project in hosted mode by either running _!GearsOfflineTutorial-shell_ from the command line or using the _Run_ configuration from Eclipse.  

 _ Note: Using hosted mode with the Gears project will only work on Windows as of the GWT 1.5 release. _

 _ Note: The Offline support from Gears will not work with a URL that begins with `file:///`, so upload your project to a web server to test offline support._

If you would like to see your project in your host's web browser (web mode), press the _Compile/Browse_ button in hosted mode.  Try your application in a browser with and without the Gears plugin installed to see how it behaves.
